<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Clone - Pro</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #36393f;
            --bg-side: #2f3136;
            --bg-input: #40444b;
            --discord-blue: #5865f2;
            --discord-green: #3ba55d;
            --discord-red: #ed4245;
            --text-main: #dcddde;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width: 260px;
            background-color: var(--bg-side);
            display: flex;
            flex-direction: column;
            padding: 20px 15px;
            border-left: 1px solid #202225;
        }

        .main-chat { flex: 1; display: flex; flex-direction: column; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        #chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }

        .message { 
            background: #32353b; 
            padding: 12px; 
            border-radius: 8px; 
            border-right: 4px solid var(--discord-blue);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .user-name { font-weight: bold; color: #fff; margin-left: 10px; color: #00aff4; font-size: 0.9em; }
        .text { display: block; margin-top: 4px; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        #input-area { 
            background-color: var(--bg-dark); 
            padding: 20px; 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid #40444b;
        }

        input { 
            flex: 1; padding: 12px; border: none; border-radius: 8px; 
            background-color: var(--bg-input); color: white; outline: none; 
        }

        .btn { 
            padding: 10px 20px; border: none; border-radius: 5px; 
            color: white; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-send { background-color: var(--discord-blue); }
        .btn-voice { background-color: var(--discord-green); width: 100%; margin-top: 10px; }
        .btn-mute { background-color: var(--discord-red); width: 100%; margin-top: 5px; display: none; }

        .status-card {
            background: #292b2f;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .online-badge {
            width: 10px; height: 10px; background: var(--discord-green);
            border-radius: 50%; display: inline-block; margin-left: 5px;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: white; font-size: 1.2em; margin-bottom: 20px;">Discord Clone</h2>
        
        <div style="margin-bottom: 20px;">
            <label style="font-size: 0.8em; display: block; margin-bottom: 5px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ©:</label>
            <input id="username" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." style="width: 85%;">
            <small style="font-size: 0.7em; color: #8e9297;">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
        </div>

        <div class="status-card">
            <p style="margin: 0; font-size: 0.9em;"><span class="online-badge"></span> Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ØµÙˆØªÙŠ:</p>
            <button id="start-voice" class="btn btn-voice">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØµÙˆØªÙŠØ©</button>
            <button id="mute-btn" class="btn btn-mute">ÙƒØªÙ… Ø§Ù„ØµÙˆØª</button>
            <div id="voice-info" style="font-size: 0.75em; margin-top: 8px; color: #b9bbbe;">ØºÙŠØ± Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        </div>
    </div>

    <div class="main-chat">
        <div id="chat-container"></div>

        <form id="chat-form">
            <div id="input-area">
                <input id="message-input" type="text" placeholder="Ø§Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¹Ø§Ù…Ø©..." autocomplete="off" required>
                <button type="submit" class="btn btn-send">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </form>
    </div>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø®Ø§Øµ ---
        const ABLY_KEY = 'QM4eOw.xY9zIA:gq3Qc0mxi12fEJZCzygsUQqp0Uz97U0tWZWCvVWTbN4';
        const ably = new Ably.Realtime(ABLY_KEY); 
        const chatChannel = ably.channels.get('chat-room');
        const voiceChannel = ably.channels.get('voice-logic');
        
        const peer = new Peer(); 
        let myPeerId = "";
        let localStream;

        const chatContainer = document.getElementById('chat-container');
        const usernameInput = document.getElementById('username');
        const messageInput = document.getElementById('message-input');
        const voiceBtn = document.getElementById('start-voice');
        const muteBtn = document.getElementById('mute-btn');
        const voiceInfo = document.getElementById('voice-info');

        // --- 2. Ù…ÙŠØ²Ø© Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… (LocalStorage) ---
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        const savedName = localStorage.getItem('discord_user_name');
        if (savedName) {
            usernameInput.value = savedName;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        usernameInput.addEventListener('input', () => {
            localStorage.setItem('discord_user_name', usernameInput.value);
        });

        // --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ---
        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = usernameInput.value || "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„";
            chatChannel.publish('message', { user, text: messageInput.value });
            messageInput.value = '';
        });

        chatChannel.subscribe('message', (msg) => {
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<span class="user-name">${msg.data.user}</span><span class="text">${msg.data.text}</span>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // --- 4. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ØµÙˆØªÙŠ (WebRTC) ---
        peer.on('open', (id) => { 
            myPeerId = id; 
            console.log("Ù…Ø¹Ø±Ù Ø§Ù„ØµÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:", id);
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ†
        peer.on('call', (call) => {
            navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                call.answer(stream); // Ø§Ù„Ø±Ø¯ Ø¨Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ
                call.on('stream', (remoteStream) => { playRemoteAudio(remoteStream); });
            });
        });

        voiceBtn.addEventListener('click', async () => {
            try {
                // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceBtn.style.display = 'none';
                muteBtn.style.display = 'block';
                voiceInfo.innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„ØµÙˆØª âœ… (ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†)";
                voiceInfo.style.color = "#3ba55d";

                // Ø¨Ø« "Ù…Ø¹Ø±Ù Ø§Ù„ØµÙˆØª" Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ Ù„Ù„Ø¢Ø®Ø±ÙŠÙ† Ù„ÙŠØªÙ…ÙƒÙ†ÙˆØ§ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙŠ
                voiceChannel.publish('join-voice', { peerId: myPeerId, name: usernameInput.value });
            } catch (err) {
                alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­");
            }
        });

        // Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø¶Ù… Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØµÙˆØªÙŠØ©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        voiceChannel.subscribe('join-voice', (data) => {
            if (data.data.peerId !== myPeerId && localStream) {
                const call = peer.call(data.data.peerId, localStream);
                call.on('stream', (remoteStream) => { playRemoteAudio(remoteStream); });
            }
        });

        function playRemoteAudio(stream) {
            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.play();
        }

        // Ù…ÙŠØ²Ø© ÙƒØªÙ… Ø§Ù„ØµÙˆØª (Mute)
        muteBtn.addEventListener('click', () => {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack.enabled) {
                audioTrack.enabled = false;
                muteBtn.innerText = "ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
                muteBtn.style.backgroundColor = "#72767d";
                voiceInfo.innerText = "Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ÙƒØªÙˆÙ… ğŸ¤";
            } else {
                audioTrack.enabled = true;
                muteBtn.innerText = "ÙƒØªÙ… Ø§Ù„ØµÙˆØª";
                muteBtn.style.backgroundColor = "var(--discord-red)";
                voiceInfo.innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„ØµÙˆØª âœ…";
            }
        });
    </script>
</body>
</html>
